#!/bin/bash

LOG_FILE="/var/log/ksc_install.log"
exec > >(tee -a "$LOG_FILE") 2>&1

# Show ASCII art splash
curl -sSl https://raw.githubusercontent.com/KaiserVonLulz/install_ksc/refs/heads/main/splash | bash

# Check for root
if [ "$EUID" -ne 0 ]; then
  echo "‚ùå Questo script deve essere eseguito come root."
  exit 1
fi
echo "‚úÖ Esecuzione come root confermata."

# Prompt for passwords
read -s -p "üîê Inserisci la password dell'utente ksc: " KSC_PASSWORD
echo
read -s -p "üîê Inserisci la password del database PostgreSQL: " DB_PASSWORD
echo
read -p "üë§ Inserisci il nome utente per la Web Console: " WEB_USER
read -s -p "üîê Inserisci la password per l'utente Web Console: " WEB_PASSWORD
echo

# Create user and group
groupadd -f kladmins
id -u ksc &>/dev/null || useradd -m -s /bin/bash ksc
echo "ksc:$KSC_PASSWORD" | chpasswd
usermod -g kladmins ksc
echo "‚úÖ Utente e gruppo ksc/kladmins creati."

# Install PostgreSQL
apt update && apt install postgresql -y
if [ $? -ne 0 ]; then echo "‚ùå Errore installazione PostgreSQL"; exit 1; fi

# Create PostgreSQL user and database
sudo -u postgres psql -c "CREATE USER ksc WITH PASSWORD '$DB_PASSWORD' SUPERUSER;" || { echo "‚ùå Errore creazione utente PostgreSQL"; exit 1; }
sudo -u postgres createdb -O ksc KAV || { echo "‚ùå Errore creazione database KAV"; exit 1; }

# Create answers.txt
mkdir -p /tmp/ksc_install
cat <<EOF > /tmp/ksc_install/answers.txt
EULA_ACCEPTED=1
PP_ACCEPTED=1
KLSRV_UNATT_SERVERADDRESS=127.0.0.1
KLSRV_UNATT_DBMS_TYPE=postgresql
KLSRV_UNATT_DBMS_INSTANCE=127.0.0.1
KLSRV_UNATT_DBMS_PORT=5432
KLSRV_UNATT_DB_NAME=KAV
KLSRV_UNATT_DBMS_LOGIN=ksc
KLSRV_UNATT_DBMS_PASSWORD=$DB_PASSWORD
KLSRV_UNATT_KLADMINSGROUP=kladmins
KLSRV_UNATT_KLSRVUSER=ksc
KLSRV_UNATT_KLSVCUSER=ksc
EOF
export KLAUTOANSWERS=/tmp/ksc_install/answers.txt
echo "‚úÖ File answers.txt creato e variabile KLAUTOANSWERS esportata."

# Download and install KSC
wget -P /tmp/ https://products.s.kaspersky-labs.com/administrationkit/ksc10/15.4.0.8873/english-24733053-en/3939393939367c44454c7c31/ksc64_15.4.0-8873_amd64.deb
apt install /tmp/ksc64_15.4.0-8873_amd64.deb -y
if [ $? -ne 0 ]; then echo "‚ùå Errore installazione KSC"; exit 1; fi

# Create Web Console user
/opt/kaspersky/ksc64/sbin/kladduser -n "$WEB_USER" -p "$WEB_PASSWORD"
if [ $? -ne 0 ]; then echo "‚ùå Errore creazione utente Web Console"; exit 1; fi

# Create Web Console config
cat <<EOF > /etc/ksc-web-console-setup.json
{
  "address": "127.0.0.1",
  "port": 8080,
  "trusted": "127.0.0.1|13299|/var/opt/kaspersky/klnagent_srv/1093/cert/klserver.cer|KSC Server",
  "acceptEula": true
}
EOF
echo "‚úÖ File di configurazione Web Console creato."

# Download and install Web Console
wget -P /tmp/ https://products.s.kaspersky-labs.com/administrationkit/ksc10/15.4.0.8952/english-25132578-en/313031343938397c44454c7c31/ksc-web-console-15.4.1021.x86_64.deb
dpkg -i /tmp/ksc-web-console-15.4.1021.x86_64.deb
if [ $? -ne 0 ]; then echo "‚ùå Errore installazione Web Console"; exit 1; fi

# Final message
IP=$(hostname -I | awk '{print $1}')
echo "‚úÖ Installazione completata!"
echo "üåê Accedi alla Web Console: http://$IP:8080"
echo "üë§ Utente: $WEB_USER"
echo "üîê Password: $WEB_PASSWORD"
